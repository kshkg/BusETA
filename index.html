<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>115及115P路線到站時間｜紅樂道 (合併列表)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Microsoft JhengHei", "Heiti HK", Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      line-height: 1.4;
      -webkit-text-size-adjust: 100%;
      -moz-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    #current-time {
      font-size: 1.4em;
      color: #1266af;
      font-weight: bold;
      margin: 1rem auto;
      text-align: center;
      max-width: 95vw;
      word-break: break-word;
    }
    #merged-table {
      width: 100%;
      max-width: 100vw;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow-x: auto;
      display: block;
      -webkit-overflow-scrolling: touch;
    }
    table thead tr {
      background-color: #1266af;
      color: #fff;
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    #merged-table tbody {
      display: block;
      max-height: 60vh;
      overflow-y: auto;
      width: 100%;
    }
    #merged-table tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
      border-bottom: 1px solid #ddd;
      word-break: break-word;
    }
    th, td {
      padding: 0.7em 0.9em;
      text-align: center;
      font-size: 1rem;
      border-right: 1px solid #ddd;
      vertical-align: middle;
    }
    th:last-child, td:last-child {
      border-right: none;
    }
    tbody tr:hover {
      background-color: #f0f8ff;
    }
    .company-cell {
      font-weight: 700;
      color: #0099cc;
      white-space: nowrap;
    }
    .countdown {
      color: #666;
    }
    .remark {
      color: #cc3300;
      font-weight: 600;
      font-size: 0.9em;
      white-space: normal;
      word-wrap: break-word;
    }
    .updated {
      font-size: 0.85em;
      color: #888;
      margin-top: 1em;
      text-align: right;
      max-width: 95vw;
      word-break: break-word;
    }

    /* Scrollbar styling for modern browsers */
    #merged-table tbody::-webkit-scrollbar {
      width: 6px;
    }
    #merged-table tbody::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 3px;
    }

    @media screen and (max-width: 600px) {
      th, td {
        padding: 0.5em 0.7em;
        font-size: 0.9rem;
      }
      #current-time {
        font-size: 1.2em;
        margin: 1rem 0.5rem;
      }
      .remark {
        font-size: 0.8em;
      }
      #merged-table tbody {
        max-height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div id="current-time">載入香港時間...</div>
  <table aria-label="115及115P路線到站時間合併列表" role="table" id="merged-table">
    <thead>
      <tr>
        <th>公司</th>
        <th>路線</th>
        <th>預計到站時間</th>
        <th>倒數</th>
        <th>目的地</th>
        <th>備註</th>
      </tr>
    </thead>
    <tbody id="merged-tbody">
      <tr><td colspan="6">載入中...</td></tr>
    </tbody>
  </table>
  <div class="updated" id="updated-time"></div>

  <script>
    function formatTimeFull(dt) {
      const t = new Date(dt);
      return `${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`;
    }
    function formatTime(dt) {
      const t = new Date(dt);
      return `${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;
    }
    function getCountdownMinutes(eta) {
      const now = new Date();
      const etaDate = new Date(eta);
      const diff = (etaDate - now) / 60000;
      return diff > 0 ? diff : 0;
    }
    function formatCountdown(minutes) {
      if (minutes <= 1 && minutes > 0) return "即將到達";
      if (minutes === 0) return "已離站";
      return Math.floor(minutes) + "分鐘後";
    }

    const currentTimeDiv = document.getElementById("current-time");
    const mergedTbody = document.getElementById("merged-tbody");
    const updatedTimeDiv = document.getElementById("updated-time");

    function updateHKTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const hkTime = new Date(utc + 3600000 * 8);
      currentTimeDiv.textContent = "香港時間: " + formatTimeFull(hkTime);
    }

    async function fetchCitybusETAForRoute(route) {
      const url = `https://rt.data.gov.hk/v2/transport/citybus/eta/ctb/003269/${route}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        let data = json.data || [];
        // exclude entries with remark "九巴時段"
        data = data.filter(bus => bus.rmk_tc !== "九巴時段");
        return data.map(bus => ({
          company: "城巴",
          route,
          eta: bus.eta || null,
          dest: bus.dest_tc || "",
          remark: bus.rmk_tc || ""
        }));
      } catch {
        return null;
      }
    }

    async function fetchKmbETAForRoute(route) {
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/eta/36F7DCE4723C2C44/${route}/1`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        let data = json.data || [];
        return data.map(bus => ({
          company: "九巴",
          route,
          eta: bus.eta || null,
          dest: bus.dest_tc || "",
          remark: bus.rmk_tc || ""
        }));
      } catch {
        return null;
      }
    }

    function renderMergedTable(data) {
      if (!data) {
        mergedTbody.innerHTML = `<tr><td colspan="6">無法載入資料。</td></tr>`;
        return;
      }
      if (data.length === 0) {
        mergedTbody.innerHTML = `<tr><td colspan="6">暫無即將到站班次。</td></tr>`;
        return;
      }
      const rowsHtml = data.map(bus => {
        if (!bus.eta) {
          return `
            <tr>
              <td class="company-cell">${bus.company}</td>
              <td>${bus.route}</td>
              <td>暫無到站資料</td>
              <td>—</td>
              <td>${bus.dest}</td>
              <td><span class="remark">${bus.remark}</span></td>
            </tr>`;
        }
        const etaTime = formatTime(bus.eta);
        const countdown = formatCountdown(getCountdownMinutes(bus.eta));
        return `
            <tr>
              <td class="company-cell">${bus.company}</td>
              <td>${bus.route}</td>
              <td>${etaTime}</td>
              <td class="countdown">${countdown}</td>
              <td>${bus.dest}</td>
              <td><span class="remark">${bus.remark}</span></td>
            </tr>`;
      }).join("");
      mergedTbody.innerHTML = rowsHtml;
    }

    async function refreshAll() {
      const citybus115Data = await fetchCitybusETAForRoute("115");
      const citybus115PData = await fetchCitybusETAForRoute("115P");
      const kmb115Data = await fetchKmbETAForRoute("115");
      const kmb115PData = await fetchKmbETAForRoute("115P");

      const combined = []
        .concat(citybus115Data || [])
        .concat(citybus115PData || [])
        .concat(kmb115Data || [])
        .concat(kmb115PData || []);

      combined.sort((a, b) => {
        if (!a.eta && !b.eta) return 0;
        if (!a.eta) return 1;
        if (!b.eta) return -1;
        return new Date(a.eta) - new Date(b.eta);
      });

      renderMergedTable(combined);
      updatedTimeDiv.textContent = "資料最後更新: " + formatTimeFull(new Date());
    }

    updateHKTime();
    refreshAll();
    setInterval(updateHKTime, 1000);
    setInterval(refreshAll, 10000);
  </script>
</body>
</html>
